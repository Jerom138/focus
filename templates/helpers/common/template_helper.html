<!DOCTYPE html><html lang="en"><head><title>templates/helpers/common/template_helper</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="templates/helpers/common/template_helper"><meta name="groc-project-path" content="lib/templates/helpers/common/template_helper.coffee"><meta name="groc-github-url" content="https://github.com/KleeGroup/focus"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/KleeGroup/focus/blob/master/lib/templates/helpers/common/template_helper.coffee">lib/templates/helpers/common/template_helper.coffee</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-comment">#global $, _</span>
<span class="hljs-string">"use strict"</span>
<span class="hljs-function"><span class="hljs-params">((NS) -&gt;</span></span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Filename: lib/templates/view_helper/template_helper.coffee */</p></div></div><div class="code"><div class="wrapper">  NS = NS <span class="hljs-keyword">or</span> {}
  isInBrowser = <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> <span class="hljs-keyword">is</span> <span class="hljs-string">'undefined'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> <span class="hljs-keyword">isnt</span> <span class="hljs-string">'undefined'</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Other module dependencies.</p></div></div><div class="code"><div class="wrapper">  metadataBuilder = <span class="hljs-keyword">if</span> isInBrowser <span class="hljs-keyword">then</span> NS.Helpers.metadataBuilder <span class="hljs-keyword">else</span> <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../helpers/metadata_builder'</span>).metadataBuilder
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Dependency on the configuration.</p></div></div><div class="code"><div class="wrapper">  domains_definition = <span class="hljs-literal">undefined</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Default options</p></div></div><div class="code"><div class="wrapper">  isDateHTML5 = <span class="hljs-literal">true</span>
  gridSize = <span class="hljs-number">12</span>
  defaultLabelSize = <span class="hljs-number">3</span>
  defaultInputSize =  <span class="hljs-number">8</span>

  <span class="hljs-comment">#initialize the template helper.</span>
  <span class="hljs-attribute">configure</span>: <span class="hljs-function"><span class="hljs-params">(options)</span>-&gt;</span>
    domains_definition = options.domains
    isDateHTML5 = options.isDateHTML5 <span class="hljs-keyword">or</span> isDateHTML5
    gridSize = options.gridSize <span class="hljs-keyword">or</span> gridSize
    defaultLabelSize = options.labelSize
    defaultInputSize = options.inputSize <span class="hljs-keyword">or</span> defaultInputSize

  <span class="hljs-comment">#S4  </span>
  <span class="hljs-function"><span class="hljs-title">S4</span> = -&gt;</span>
    (((<span class="hljs-number">1</span> + Math.random()) * <span class="hljs-number">0x10000</span>) | <span class="hljs-number">0</span>).toString(<span class="hljs-number">16</span>).substring <span class="hljs-number">1</span>

  <span class="hljs-comment">#Generate a pseudo-GUID by concatenating random hexadecimal.  </span>
  <span class="hljs-function"><span class="hljs-title">guid</span> = -&gt;</span>
    S4() + S4() + <span class="hljs-string">"-"</span> + S4() + <span class="hljs-string">"-"</span> + S4() + <span class="hljs-string">"-"</span> + S4() + <span class="hljs-string">"-"</span> + S4() + S4() + S4()
  
  <span class="hljs-comment">#Container for all the fields helpers. display_for, input_for, option_selected</span>
  fieldHelpers = {}
  fieldHelpers.<span class="hljs-function"><span class="hljs-title">process</span> = <span class="hljs-params">(property,options, context)</span>-&gt;</span>
    options = options <span class="hljs-keyword">or</span> {}
    result = {}
    fieldHelpers.processMetadatas(property,options, result, context)
    fieldHelpers.processDomain(property,options, result, context)
    fieldHelpers.processOptions(property,options, result, context)


    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Process all options which are givent to the field helper.</p></div></div><div class="code"><div class="wrapper">  fieldHelpers.<span class="hljs-function"><span class="hljs-title">processOption</span> = <span class="hljs-params">(property,options, result, context)</span>-&gt;</span>
    opt = options
    metadata = result.metadata
    result.options = optionsHelpers.process(opt, metadata)
    <span class="hljs-keyword">return</span> result.options</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Process all options which are givent to the field helper.</p></div></div><div class="code"><div class="wrapper">  fieldHelpers.<span class="hljs-function"><span class="hljs-title">processMetadatas</span> = <span class="hljs-params">(property,options, result, context)</span>-&gt;</span>
    result.metadata = metadataBuilder.getMetadataForAttribute(context,property)
    <span class="hljs-keyword">return</span> result.metadata</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Process all options which are givent to the field helper.</p></div></div><div class="code"><div class="wrapper">  fieldHelpers.<span class="hljs-function"><span class="hljs-title">processDomain</span> = <span class="hljs-params">(property,options, result, context)</span>-&gt;</span>
    result.domain = domains_definition[result.metadata.domain] <span class="hljs-keyword">or</span> {}
    <span class="hljs-keyword">return</span> result.domain
  fieldHelpers.<span class="hljs-function"><span class="hljs-title">processInputPropertyValue</span> = <span class="hljs-params">(property,options, result, context)</span>-&gt;</span>
     <span class="hljs-keyword">if</span> context[property]?
      propValue = context[property]
      metadata = result.metadata
      <span class="hljs-keyword">if</span> metadata.format?
        propValue =  metadata.format(propValue)
      <span class="hljs-keyword">if</span> dataType <span class="hljs-keyword">is</span> <span class="hljs-string">"checkbox"</span>
        <span class="hljs-keyword">if</span> propValue <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">'checked'</span>
      <span class="hljs-keyword">if</span> dataType <span class="hljs-keyword">is</span> <span class="hljs-string">"date"</span> <span class="hljs-keyword">and</span> propValue <span class="hljs-keyword">isnt</span> <span class="hljs-string">""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"value='"</span> + propValue + <span class="hljs-string">"'"</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"value='<span class="hljs-subst">#{_.escape(propValue)}</span>'"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">""</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Process the label translation.</p></div></div><div class="code"><div class="wrapper">  fieldHelpers.<span class="hljs-function"><span class="hljs-title">processTranslation</span> = <span class="hljs-params">(property, options, result, context)</span>-&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">'i18n is not defined'</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> i18n? 
    metadata = result.metadata
    translationRoot = result.options.translationRoot
    translation = metadata.label <span class="hljs-keyword">or</span> (<span class="hljs-string">"<span class="hljs-subst">#{context[<span class="hljs-string">'modelName'</span>]}</span>.<span class="hljs-subst">#{property}</span>"</span> <span class="hljs-keyword">if</span> context[<span class="hljs-string">'modelName'</span>]?) <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> translationRoot?
      translation = ((<span class="hljs-keyword">if</span> (translationRoot?) <span class="hljs-keyword">and</span> <span class="hljs-keyword">typeof</span> translationRoot <span class="hljs-keyword">is</span> <span class="hljs-string">"string"</span> <span class="hljs-keyword">then</span> translationRoot + <span class="hljs-string">"."</span> <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>)) + property
    result.translation =  <span class="hljs-keyword">if</span>(translation <span class="hljs-keyword">is</span> <span class="hljs-string">""</span>) <span class="hljs-keyword">then</span> <span class="hljs-string">""</span> <span class="hljs-keyword">else</span> i18n.t(translation)
    <span class="hljs-keyword">return</span> result.translation
  htmlHelpers = {}
  <span class="hljs-comment">#Deal with the icon case</span>
  htmlHelpers.<span class="hljs-function"><span class="hljs-title">processIcon</span> =<span class="hljs-params">(property, options, result, context)</span>-&gt;</span>
    <span class="hljs-comment">#&lt;span class='glyphicon glyphicon-#{opt.icon}'&gt;&lt;/span&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> result.params.icon? <span class="hljs-keyword">then</span> <span class="hljs-string">"&lt;span class='input-group-addon'&gt;&lt;i class='fa fa-<span class="hljs-subst">#{result.params.icon}</span>  fa-fw'&gt;&lt;/i&gt; &lt;/span&gt;"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>

  <span class="hljs-comment">#Process the labels.</span>
  htmlHelpers.<span class="hljs-function"><span class="hljs-title">processLabel</span> =<span class="hljs-params">(property, options, result, context)</span>-&gt;</span>
    opt = result.params
    <span class="hljs-keyword">if</span> opt.isNoLabel?
      <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;label class='control-label <span class="hljs-subst">#{opt.labelSize}</span>' for='<span class="hljs-subst">#{property}</span>'&gt;<span class="hljs-subst">#{result.translation}</span>&lt;/label&gt;"</span>
  
  <span class="hljs-comment">#Todo:</span>
  htmlHelpers.<span class="hljs-function"><span class="hljs-title">processErrors</span> =<span class="hljs-params">(property, options, result, context)</span>-&gt;</span>
    <span class="hljs-comment">#tofdo: move into form size calculation.</span>
    error = <span class="hljs-string">""</span>
    error = <span class="hljs-string">"has-error"</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@errors</span>? <span class="hljs-keyword">and</span> <span class="hljs-property">@errors</span>[property]?
    errorValue = <span class="hljs-keyword">if</span> <span class="hljs-property">@errors</span>? <span class="hljs-keyword">and</span> <span class="hljs-property">@errors</span>[property]? <span class="hljs-keyword">then</span> <span class="hljs-property">@errors</span>[property] <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
    <span class="hljs-function"><span class="hljs-title">errorSize</span> = <span class="hljs-params">()</span>=&gt;</span>
      errorLength = gridSize - labelSizeValue
      offsetError = labelSizeValue
      <span class="hljs-keyword">return</span> <span class="hljs-string">"col-sm-<span class="hljs-subst">#{errorLength}</span> col-md-<span class="hljs-subst">#{errorLength}</span> col-lg-<span class="hljs-subst">#{errorLength}</span> col-sm-offset-<span class="hljs-subst">#{offsetError}</span> col-md-offset-<span class="hljs-subst">#{offsetError}</span> col-lg-offset-<span class="hljs-subst">#{offsetError}</span>"</span>
    <span class="hljs-comment">#Deal with error</span>
    <span class="hljs-function"><span class="hljs-title">errors</span> = <span class="hljs-params">()</span>=&gt;</span>
      <span class="hljs-keyword">if</span> error == <span class="hljs-string">"has-error"</span> <span class="hljs-keyword">then</span> <span class="hljs-string">"&lt;span class='<span class="hljs-subst">#{error}</span> <span class="hljs-subst">#{errorSize()}</span> help-inline pull-left' style='color:#b94a48'&gt; <span class="hljs-subst">#{errorValue }</span> &lt;/span&gt;"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
    <span class="hljs-keyword">return</span> errors()
  
  <span class="hljs-comment">#Container for the options helper.</span>
  optionsHelpers = {}

  <span class="hljs-comment">#Process all options helpers.</span>
  optionsHelpers.<span class="hljs-function"><span class="hljs-title">process</span> = <span class="hljs-params">(opt, metadata)</span>-&gt;</span>
    options = {
      <span class="hljs-attribute">required</span>: optionsHelpers.required(opt, metadata),
      <span class="hljs-attribute">symbol</span>: optionsHelpers.symbol(opt, metadata),
      <span class="hljs-attribute">dataType</span>: optionsHelpers.dataType(opt, metadata),
      <span class="hljs-attribute">readonly</span>: optionsHelpers.readonly(opt, metadata),
      <span class="hljs-attribute">formSize</span>: optionsHelpers.formSize(opt, metadata),
      <span class="hljs-attribute">isNoLabel</span>: opt.isNoLabel,
      <span class="hljs-attribute">isAddOnInput</span>: optionsHelpers.isAddOnInput(opt, metadata)
      <span class="hljs-attribute">translationRoot</span>: opt.translationRoot <span class="hljs-keyword">or</span> <span class="hljs-literal">undefined</span>
      <span class="hljs-attribute">icon</span>: opt.icon
    }
    <span class="hljs-keyword">return</span> options

  <span class="hljs-comment">#If a field is required by its metadata or with the view helper definition, a * is return.</span>
  optionsHelpers.<span class="hljs-function"><span class="hljs-title">required</span> = <span class="hljs-params">(opt, metadata)</span>-&gt;</span>
    required = <span class="hljs-literal">undefined</span>
    <span class="hljs-keyword">if</span> opt.isRequired?
      required = <span class="hljs-keyword">if</span> opt.isRequired <span class="hljs-keyword">then</span> <span class="hljs-string">"*"</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">undefined</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> metadata.required?
      required = <span class="hljs-keyword">if</span> opt.isRequired <span class="hljs-keyword">then</span> <span class="hljs-string">"*"</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">undefined</span>
    <span class="hljs-keyword">return</span> required
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If a symbol is define in the metadata or in the view helper, it will be display.</p></div></div><div class="code"><div class="wrapper">  optionsHelpers.<span class="hljs-function"><span class="hljs-title">symbol</span> = <span class="hljs-params">(opt, metadata)</span>-&gt;</span>
    symbol = <span class="hljs-literal">undefined</span>
    <span class="hljs-keyword">if</span> opt.symbol?
      symbol = opt.symbol
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> metadata.symbol?
      symbol = metadata.symbol
    <span class="hljs-keyword">return</span> symbol
  
  <span class="hljs-comment">#Process the datatype, mainly use into html5 fields.</span>
  optionsHelpers.<span class="hljs-function"><span class="hljs-title">dataType</span> = <span class="hljs-params">(opt, metadata)</span>-&gt;</span>
    dataType = opt.dataType <span class="hljs-keyword">or</span> domain.type <span class="hljs-keyword">or</span> <span class="hljs-string">"text"</span>
    <span class="hljs-keyword">if</span> dataType <span class="hljs-keyword">is</span> <span class="hljs-string">"boolean"</span>
      dataType = <span class="hljs-string">"checkbox"</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> dataType <span class="hljs-keyword">is</span> <span class="hljs-string">"date"</span>  
      (dataType = <span class="hljs-string">"text"</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isDateHTML5
    <span class="hljs-keyword">return</span> dataType</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Process the readonly attribute</p></div></div><div class="code"><div class="wrapper">  optionsHelpers.<span class="hljs-function"><span class="hljs-title">readonly</span> = <span class="hljs-params">(opt, metadata)</span>-&gt;</span>
    readonly = opt.readonly <span class="hljs-keyword">or</span> <span class="hljs-literal">false</span>
    readonly = <span class="hljs-keyword">if</span> readonly <span class="hljs-keyword">then</span> <span class="hljs-string">"readonly"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check if a field is disable or not. </p></div></div><div class="code"><div class="wrapper">  optionsHelpers.<span class="hljs-function"><span class="hljs-title">disabled</span> = <span class="hljs-params">(opt, metadata)</span>-&gt;</span>
    disabled = opt.disabled <span class="hljs-keyword">or</span> <span class="hljs-literal">false</span>
    disabled = <span class="hljs-keyword">if</span> disabled <span class="hljs-keyword">then</span> <span class="hljs-string">"disabled"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
  
  <span class="hljs-comment">#Formsize processing: label, input.</span>
  optionsHelpers.<span class="hljs-function"><span class="hljs-title">formSize</span> = <span class="hljs-params">(opt, metadata)</span>-&gt;</span>
    size = {}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Process the label size.</p></div></div><div class="code"><div class="wrapper">    size.label = <span class="hljs-keyword">if</span> opt.isNoLabel <span class="hljs-keyword">then</span> <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> opt.labelSize <span class="hljs-keyword">then</span> opt.labelSize <span class="hljs-keyword">else</span> defaultLabelSize</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Process the input size.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> opt.containerCss
      size.input = <span class="hljs-string">""</span>
    <span class="hljs-keyword">else</span>
      size.input  = gridSize - size.label
    <span class="hljs-keyword">return</span> size
  <span class="hljs-comment">#Define if an input needs a addon.</span>
  optionsHelpers.<span class="hljs-function"><span class="hljs-title">isAddOnInput</span> = <span class="hljs-params">(opt, metadata)</span>-&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">or</span> opt.icon? <span class="hljs-keyword">or</span> ((opt.isRequired || metadata.required)) <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">or</span> ((opt.symbol || metadata.symbol))?


    <span class="hljs-keyword">return</span> size
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>All methods which has to be displayed to the module.</p></div></div><div class="code"><div class="wrapper">  mod = {
    <span class="hljs-attribute">guid</span>: guid,
    <span class="hljs-attribute">processField</span>: process
  }
  <span class="hljs-keyword">if</span> isInBrowser
    NS.Helpers = NS.Helpers <span class="hljs-keyword">or</span> {}
    NS.Templates.helpers = mod
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">module</span>.<span class="hljs-built_in">exports</span> = mod
)(<span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> <span class="hljs-keyword">is</span> <span class="hljs-string">'undefined'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> <span class="hljs-keyword">isnt</span> <span class="hljs-string">'undefined'</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">window</span>.Fmk <span class="hljs-keyword">else</span> <span class="hljs-built_in">module</span>.<span class="hljs-built_in">exports</span>)</div></div></div></div></body></html>