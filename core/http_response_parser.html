<!DOCTYPE html><html lang="en"><head><title>core/http_response_parser</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="core/http_response_parser"><meta name="groc-project-path" content="lib/core/http_response_parser.js"><meta name="groc-github-url" content="https://github.com/KleeGroup/focus"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/KleeGroup/focus/blob/master/lib/core/http_response_parser.js">lib/core/http_response_parser.js</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-comment">/*global _, window*/</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Module core/http_response_parser see file helpers/backbone_notifications.js and author pbesson</span></p>
<p>Global notifications mecanism around the whole application.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>  Jquery ajax error and success <a href="http://api.jquery.com/jquery.ajax/">documentation</a>.
  error
    Type: Function( jqXHR jqXHR, String textStatus, String errorThrown )
    A function to be called if the request fails. The function receives three arguments: The jqXHR (in jQuery 1.4.x, XMLHttpRequest) object, a string describing the type of error that occurred and an optional exception object, if one occurred. Possible values for the second argument (besides null) are &quot;timeout&quot;, &quot;error&quot;, &quot;abort&quot;, and &quot;parsererror&quot;. When an HTTP error occurs, errorThrown receives the textual portion of the HTTP status, such as &quot;Not Found&quot; or &quot;Internal Server Error.&quot; As of jQuery 1.5, the error setting can accept an array of functions. Each function will be called in turn. Note: This handler is not called for cross-domain script and cross-domain JSONP requests. This is an Ajax Event.
  success: 
    Type: Function( PlainObject data, String textStatus, jqXHR jqXHR )
    A function to be called if the request succeeds. The function gets passed three arguments: The data returned from the server, formatted according to the dataType parameter; a string describing the status; and the jqXHR (in jQuery 1.4.x, XMLHttpRequest) object. As of jQuery 1.5, the success setting can accept an array of functions. Each function will be called in turn. This is an Ajax Event.</p></div></div><div class="code"><div class="wrapper">(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(NS)</span> {</span>
<span class="hljs-pi">  "use strict"</span>;
  NS = NS || {};

  <span class="hljs-comment">//Dependencies.</span>
  <span class="hljs-comment">//Dependency gestion depending on the fact that we are in the browser or in node.</span>
  <span class="hljs-keyword">var</span> isInBrowser = <span class="hljs-keyword">typeof</span> module === <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> window !== <span class="hljs-string">'undefined'</span>;
  <span class="hljs-keyword">var</span> ArgumentNullException = isInBrowser ? NS.Helpers.Exceptions.ArgumentNullException : <span class="hljs-built_in">require</span>(<span class="hljs-string">"./custom_exception"</span>).ArgumentNullException;
  <span class="hljs-keyword">var</span> httpHelper = isInBrowser ? NS.Helpers.httpHelper : <span class="hljs-built_in">require</span>(<span class="hljs-string">"../helpers/http_helper"</span>);</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> of type <em>Object</em></span></p>
<p>Default configuration.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> config = {
    totalCountKey: <span class="hljs-string">"odata.count"</span>,
    valuesKey: <span class="hljs-string">"values"</span>
  };</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Configure the response parser.</p>
<p>Parameters:</p>
<ul>
<li><strong>extendConf must be an object.</strong><br/>(- the property you want to configure in the configuration.)</li>
</ul>
<p><strong>Returns a [type]</strong><br/>([description])</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> configure = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">configureHttpResponseParser</span><span class="hljs-params">(extendConf)</span> {</span>
    <span class="hljs-keyword">if</span> (!_.isObject(extendConf)) {
      <span class="hljs-keyword">return</span>;
    }
    _.extend(config, extendConf);
  };</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> of type <em>Object</em></span></p>
<p>All the headers.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> HEADERS_KEYS = {
    CONTENT_TYPE: <span class="hljs-string">"Content-Type"</span>,
    TOTAL_COUNT: <span class="hljs-string">"X-Total-Count"</span>,
    ACCESS_TOKEN: <span class="hljs-string">"x-access-token"</span>
  };</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> of type <em>Object</em></span></p>
<p>All the content types.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> CONTENT_TYPES = {
    LIST: <span class="hljs-string">"application/json+list"</span>,
    LIST_META: <span class="hljs-string">"application/json+list+meta"</span>,
    ENTITY_DESC: <span class="hljs-string">"applicatin/json+"</span>,
    ENTITY: <span class="hljs-string">"application/json"</span>
  };</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Get the object name from the content type.</p>
<p>Parameters:</p>
<ul>
<li><strong>contentType must be a string.</strong><br/>(- The content type.)</li>
</ul>
<p><strong>Returns a string</strong><br/>(The name of the object.)</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> getObjectName = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getObjectNameFromContentType</span><span class="hljs-params">(contentType)</span> {</span>
    <span class="hljs-keyword">var</span> splitContent = contentType.split(<span class="hljs-string">'+'</span>);
    <span class="hljs-keyword">if</span> (splitContent !== <span class="hljs-literal">undefined</span> &amp;&amp; splitContent.length &gt; <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span> splitContent[<span class="hljs-number">1</span>].split(<span class="hljs-string">';'</span>)[<span class="hljs-number">0</span>];

    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  };</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Parse an entity http response.</p>
<p>Parameters:</p>
<ul>
<li><p><strong>response must be a jqXHR.</strong><br/>(- jQuery XmlHttpRequest.)</p>
</li>
<li><p><strong>contentType must be an object.</strong><br/>(- Object name in the contentType.)</p>
</li>
</ul>
<p><strong>Returns an object</strong><br/>(- The parse response.)</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> entityParser = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">entityParser</span><span class="hljs-params">(response, contentType)</span> {</span>
    <span class="hljs-keyword">var</span> entity = response.responseJSON;
    <span class="hljs-comment">//Set an object name if it is given as argument.</span>
    <span class="hljs-keyword">if</span> (contentType) {
      entity._objectName = getObjectName(contentType);
    }
    <span class="hljs-keyword">return</span> entity;
  };</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Collection response parser.
{jqXHR} response - jQuery XmlHttpRequest.</p>
<p><strong>Returns an object</strong><br/>(- The parse response.)</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> collectionParser = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">collectionParser</span><span class="hljs-params">(response, isMetaInHeader)</span> {</span>

    <span class="hljs-keyword">var</span> totalCount, values;
    <span class="hljs-keyword">var</span> jsonResponse = response.responseJSON;

    <span class="hljs-keyword">if</span> (isMetaInHeader) {
      totalCount = +(response.getResponseHeader(HEADERS_KEYS.TOTAL_COUNT));
      values = jsonResponse;
      <span class="hljs-keyword">if</span> (!_.isArray(values)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-string">"response.jsonResponse."</span> + config.valuesKey + <span class="hljs-string">" should be an array."</span>, response);
      }
    } <span class="hljs-keyword">else</span> {

      totalCount = jsonResponse[config.totalCountKey] || jsonResponse.length;
      values = jsonResponse[config.valuesKey];
      <span class="hljs-keyword">if</span> (!_.isArray(values)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-string">"response.jsonResponse should be an array."</span>, response);
      }
    }

    <span class="hljs-keyword">return</span> {
      totalCount: totalCount,
      values: values
    };

  };</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Parameters:</p>
<ul>
<li><strong>response must be a [type].</strong><br/>([description])</li>
</ul>
<p><strong>Returns a [type]</strong><br/>([description])</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> parseAccessToken = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseAccessToken</span><span class="hljs-params">(response)</span> {</span>
    <span class="hljs-keyword">var</span> accessToken = response.getResponseHeader(HEADERS_KEYS.ACCESS_TOKEN);
    <span class="hljs-keyword">if</span> (accessToken) {
      httpHelper.setAccessToken(accessToken, <span class="hljs-literal">true</span>);
    }
  };</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Polyfill for the string contains method.</p>
<p>Parameters:</p>
<ul>
<li><p><strong>string must be a string.</strong><br/>(- The string to test.)</p>
</li>
<li><p><strong>pattern must be a string.</strong><br/>(- The pattern to identify.)</p>
</li>
</ul>
<p><strong>Returns a boolean</strong><br/>(true or false.)</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> contains = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stringContains</span><span class="hljs-params">(string, pattern)</span> {</span>
    <span class="hljs-keyword">if</span> (!_.isString(string)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> string.indexOf(pattern) !== -<span class="hljs-number">1</span>;
  };</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Parse HttpResponse.</p>
<p>Parameters:</p>
<ul>
<li><strong>response must be a jqXHR.</strong><br/>(- jQuery XmlHttpRequest.)</li>
</ul>
<p><strong>Returns an object</strong><br/>(- The parse response.)</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> parseResponse = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseResponse</span><span class="hljs-params">(response)</span> {</span>
    <span class="hljs-keyword">var</span> contentType = response.getResponseHeader(HEADERS_KEYS.CONTENT_TYPE);
    parseAccessToken(response);
    <span class="hljs-keyword">if</span> (contains(contentType, CONTENT_TYPES.LIST_META)) {
      <span class="hljs-keyword">return</span> collectionParser(response, <span class="hljs-literal">false</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contains(contentType, CONTENT_TYPES.LIST)) {
      <span class="hljs-keyword">return</span> collectionParser(response, <span class="hljs-literal">true</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contains(contentType, CONTENT_TYPES.ENTITY_DESC)) {
      <span class="hljs-keyword">return</span> entityParser(response, contentType);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contains(contentType, CONTENT_TYPES.ENTITY)) {
      <span class="hljs-keyword">return</span> entityParser(response);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> response.responseJSON;
    }
  };</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> of type <em>Object</em></span></p>
<p>Container for the export.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> httpResponseParser = {
    entity: entityParser,
    collection: collectionParser,
    parse: parseResponse,
    configure: configure
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Differenciating export for node or browser.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (isInBrowser) {
    NS.Core = NS.Core || {};
    NS.Core.httpResponseParser = httpResponseParser;
  } <span class="hljs-keyword">else</span> {
    module.exports = httpResponseParser;
  }
})(<span class="hljs-keyword">typeof</span> module === <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> window !== <span class="hljs-string">'undefined'</span> ? window.Fmk : module.exports);</div></div></div></div></body></html>